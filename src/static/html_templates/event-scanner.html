<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Prompt, claude-3.7-sonnet: Make a standalone webpage that continuously scans for datamatrix codes using the webcam. Use the html5-qrcode library. Show the scan results in a header that is updated in realtime, including the timestamp of the most recent scan. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataMatrix Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #result-header {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            min-height: 50px;
        }
        #reader {
            width: 100%;
            margin-bottom: 20px;
        }
        .timestamp {
            color: #666;
            font-size: 0.8em;
        }
        .scan-value {
            font-weight: bold;
            word-break: break-all;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Scanner: {{ event_name }}</h1>
    
    <div id="result-header">
        <p>Scan a DataMatrix code to see results here</p>
    </div>
    
    <button id="testScanButton">Test Scan</button>
    
    <div id="reader"></div>
    
    <script>
        async function sendScanToServer(agaid, event) {
            try {
                const response = await fetch('/events/'+event+'/scans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        badgefile_id: agaid
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const scan_result = await response.json();
                processScanResponse(scan_result);
            } catch (error) {
                console.error('Error sending scan to server:', error);
                throw error;
            }
        }

        async function processScanResponse(scan_result) {
            console.log('Scan response: ', scan_result);
            
            const attendee = scan_result['response']['attendee'];
            const event = scan_result['response']['event'];

            const resultHeader = document.getElementById('result-header');
            
            // Update the result header with attendee information and scan count
            resultHeader.innerHTML = `
                <p>Scanned: <span class="scan-value">${attendee['name_given']} ${attendee['name_family']} (#${attendee['badgefile_id']}), scan count ${event['num_scans_for_attendee']}</span></p>
                <p>Total scanned: ${event['total_attendees_scanned']} / ${event['total_scannable']}</p>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const html5QrCode = new Html5Qrcode("reader");
            const resultHeader = document.getElementById('result-header');
            let lastScannedAgaid = null; // Track the last scanned AGAID
            
            // Add event listener for the test scan button
            document.getElementById('testScanButton').addEventListener('click', function() {
                sendScanToServer(6, "signtest");
            });
            
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                // Only process if the decoded text matches the expected format (25GC followed by digits)
                if(!decodedText || !/^25GC\d+$/.test(decodedText)) return;
                const agaid = decodedText.substring(4);

                // Get current timestamp
                const now = new Date();
                const timestamp = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');
                
                // Only send to server if this is a different AGAID than the last scan
                if (agaid !== lastScannedAgaid) {
                    // Update the result header
                    resultHeader.innerHTML = `
                        <p>Last scan: <span class="scan-value">${agaid}</span></p>
                        <p>Sending to server...</p>
                    `;

                    console.log(`Code scanned: ${decodedText}`, decodedResult);
                    sendScanToServer(agaid, "{{ event_name }}");
                    lastScannedAgaid = agaid; // Update the last scanned AGAID
                } else {
                    console.log(`Duplicate scan detected for AGAID: ${agaid}. Not sending to server.`);
                }
            };
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                formatsToSupport: [ Html5QrcodeSupportedFormats.DATA_MATRIX ]
            };
            
            // Start scanning
            html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                qrCodeSuccessCallback
            ).catch(err => {
                console.error("Error starting scanner:", err);
                resultHeader.innerHTML = `
                    <p>Error starting scanner: ${err}</p>
                    <p>Please ensure you've granted camera permissions.</p>
                `;
            });
            
            // Clean up when the page is closed
            window.addEventListener('beforeunload', function() {
                html5QrCode.stop().catch(err => {
                    console.error("Error stopping scanner:", err);
                });
            });
        });
    </script>
</body>
</html>
