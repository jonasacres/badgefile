<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendee Directory</title>
  <style>
    body { 
      font-family: 'Courier New', monospace;
      background-color: #000;
      color: #0f0;
      font-size: 16px;
      line-height: 1.2;
      padding: 12px 24px;
    }
    table { 
      border-collapse: collapse;
      width: 100%;
      background-color: #000;
      font-size: 16px;
      border: 1px solid #0f0;
    }
    th, td { 
      padding: 8px;
      text-align: left; 
      border: 1px solid #0f0;
    }
    th { 
      background-color: #020;
      color: #0f0;
      font-weight: bold;
    }
    tr:hover { 
      background-color: #010; 
      cursor: pointer;
    }
    .search-box {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      font-family: 'Courier New', monospace;
      background-color: #000;
      border: 1px solid #0f0;
      color: #0f0;
    }
    .search-box:focus {
      outline: none;
      border-color: #0f0;
      box-shadow: 0 0 5px #0f0;
    }
    .search-box::placeholder {
      color: #030;
    }
    .details {
      background-color: #000;
      border: 1px solid #0f0;
    }
    .detail-label {
      font-family: 'Courier New', monospace;
      color: #0a0;
    }
    .detail-value {
      color: #0f0;
    }
    .highlight {
      background-color: #020;
      color: #0f0;
      font-weight: bold;
    }
    h1 {
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: bold;
      color: #0f0;
      text-align: center;
      margin: 10px 0;
      text-transform: uppercase;
    }
    a {
      color: #0f0;
      text-decoration: none;
    }
    a:hover {
      background-color: #0f0;
      color: #000;
    }
    
    .search-container {
      border: 2px solid #0f0;
      padding: 10px;
      margin-bottom: 20px;
    }
    
    /* Add some ASCII art borders */
    .search-container::before {
      content: "╔══════════════════════════════════╗";
      display: block;
      margin-bottom: 10px;
    }
    
    .search-container::after {
      content: "╚══════════════════════════════════╝";
      display: block;
      margin-top: 10px;
    }

    /* Add scanline effect */
    @keyframes scanline {
      0% {
        background-position: 0 -100vh;
      }
      100% {
        background-position: 0 100vh;
      }
    }

    body::after {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(
        0deg,
        rgba(0, 255, 0, 0.03) 50%,
        transparent 50%
      );
      background-size: 100% 4px;
      pointer-events: none;
      animation: scanline 10s linear infinite;
    }

    /* Add CRT monitor glow effect */
    * {
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
    }
  </style>
</head>
<body>
  <div class="search-container">
    <h1>2025 Go Congress Directory</h1>
    <input type="text" class="search-box" placeholder="Name, phone number, email, language..." id="searchInput">
  </div>
  <table>
    <tr>
      <th data-column="name_family" class="sorted" data-direction="asc">Directory Listing ⬆️</th>
    </tr>
    <script>
      fetch('./badgefile.json')
        .then(response => response.json())
        .then(data => {
          const attendees = data.attendees;
          const tbody = document.querySelector('table');
          const searchInput = document.getElementById('searchInput');
          const headers = document.querySelectorAll('th');
          attendees.forEach(attendee => {
            // eg. "Congress Director, Age 19, Translates Korean/Chinese, playing 7d, Beaverton OR"
            const parts = [];
            if (attendee.title) {
              parts.push(attendee.title);
            }

            const birthDate = new Date(attendee.date_of_birth);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear() - 
              (today.getMonth() < birthDate.getMonth() || 
               (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate()) ? 1 : 0);
            parts.push(`Age ${age}`);

            if (attendee.languages_canonical.length > 0) {
              const prefix = attendee.translator?.includes("Yes") ? "Translates" : "Speaks";
              parts.push(`${prefix} ${attendee.languages_canonical.map(lang => lang.charAt(0).toUpperCase() + lang.slice(1)).join('/')}`);
            }

            // Only include playing rank if not a non-participant
            if (attendee.regtype?.includes("Non-Participant")) {
              parts.push(`non-participant`);
            } else {
              parts.push(`playing ${attendee.badge_rating}`);
            }

            parts.push(`${attendee.city} ${attendee.state} ${attendee.country}`);

            // Join all parts with commas
            attendee.description = parts.join(", ");
          });

          function sortAttendees() {
            const sortedHeader = document.querySelector('th.sorted');
            const column = sortedHeader.dataset.column;
            const direction = sortedHeader.dataset.direction === 'asc' ? 1 : -1;

            return attendees
              .filter(a => a.status.toLowerCase() !== 'cancelled')
              .sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (typeof aVal === 'string') {
                  aVal = aVal.toLowerCase();
                  bVal = bVal.toLowerCase();
                }
                
                if (aVal === bVal) {
                  // Secondary sort by family name if values are equal
                  return a.name_family.toLowerCase() < b.name_family.toLowerCase() ? -1 : 1;
                }
                
                return aVal < bVal ? -direction : direction;
              });
          }

          headers.forEach(header => {
            header.addEventListener('click', () => {
              // Remove sort indicators from other headers
              headers.forEach(h => {
                if (h !== header) {
                  h.classList.remove('sorted');
                  h.dataset.direction = '';
                  h.textContent = h.textContent.replace(/[⬆️⬇️]/g, '');
                }
              });

              // Toggle sort direction if already sorted by this column
              if (header.classList.contains('sorted')) {
                header.dataset.direction = header.dataset.direction === 'asc' ? 'desc' : 'asc';
              } else {
                header.classList.add('sorted');
                header.dataset.direction = 'asc';
              }

              // Update header text with sort indicator
              header.textContent = header.textContent.replace(/[⬆️⬇️]/g, '');
              header.textContent += header.dataset.direction === 'asc' ? ' ⬆️' : ' ⬇️';

              renderRows(searchInput.value);
            });
          });

          function highlightText(text, filterText) {
            text = text.toString();
            if (!filterText) return text;
            
            // Split query into terms and filter out empty strings, handling quotes
            const terms = filterText.match(/[^\s"']+|"([^"]*)"|'([^']*)'/g)
              ?.map(term => term.replace(/^['"]|['"]$/g, '').toLowerCase())
              .filter(term => term.length > 0) || [];
            
            // Create a single regex that matches any of the terms
            const regex = new RegExp(`(${terms.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
          }

          let lastExpandedAttendeeId = null;

          function collapseAllRows() {
            const visibleDetails = tbody.querySelectorAll('.details.visible');
            visibleDetails.forEach(detail => {
              detail.classList.remove('visible');
              detail.previousElementSibling?.classList.remove('expanded');
            });
          }

          // Add keyboard handler
          document.addEventListener('keydown', (e) => {
            // If typing starts anywhere, focus search and include the character
            if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
              if (document.activeElement !== searchInput) {
                searchInput.focus();
                searchInput.value = e.key;
                renderRows(e.key);
                e.preventDefault();
              }
            }
            
            // Handle arrow keys
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
              e.preventDefault();
              const visibleRows = Array.from(tbody.querySelectorAll('tr:not(.details)'))
                .filter(row => row.style.display !== 'none' && !row.querySelector('th'));
              
              if (!visibleRows.length) return;
              
              const currentExpanded = tbody.querySelector('.details.visible');
              let currentIndex = currentExpanded 
                ? visibleRows.indexOf(currentExpanded.previousElementSibling)
                : -1;
              
              let newIndex;
              if (currentIndex === -1) {
                // No row expanded, start with first row
                newIndex = 0;
              } else {
                newIndex = currentIndex + (e.key === 'ArrowDown' ? 1 : -1);
              }
              
              // Bounds checking
              if (newIndex >= 0 && newIndex < visibleRows.length) {
                // First remove all expanded/visible classes
                collapseAllRows();
                
                // Then show new expanded row
                const newRow = visibleRows[newIndex];
                const newDetailsRow = newRow.nextElementSibling;
                requestAnimationFrame(() => {
                  newDetailsRow.classList.add('visible');
                  newRow.classList.add('expanded');
                });
                
                // Track the expanded attendee
                lastExpandedAttendeeId = attendees.find(a => 
                  (a.name_given + a.name_family) === newRow.querySelector('td').textContent.trim()
                )?.id;
                
                // Ensure the expanded row is visible
                newDetailsRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }
          });

          let currentExpandedRow = null;

          let selectedIndex = -1;

          function handleArrowKeys(e) {
            // Filter out both header row (th) and details rows
            const rows = Array.from(tbody.getElementsByTagName('tr'))
              .filter(row => !row.classList.contains('details') && !row.querySelector('th'));
            
            if (rows.length === 0) return;

            let newIndex = selectedIndex;

            switch (e.key) {
              case 'ArrowDown':
                e.preventDefault();
                newIndex = selectedIndex < rows.length - 1 ? selectedIndex + 1 : selectedIndex;
                break;
              case 'ArrowUp':
                e.preventDefault();
                newIndex = selectedIndex > 0 ? selectedIndex - 1 : 0;
                break;
              default:
                return;
            }

            if (newIndex !== selectedIndex || selectedIndex === -1) {
              // Remove highlight from previously selected row
              if (selectedIndex >= 0) {
                rows[selectedIndex].classList.remove('highlight');
              }
              
              // Add highlight to newly selected row
              selectedIndex = newIndex;
              rows[selectedIndex].classList.add('highlight');
              
              // Automatically expand the selected row and collapse others
              rows.forEach((row, index) => {
                const detailsRow = row.nextElementSibling;
                if (index === selectedIndex) {
                  detailsRow.style.display = 'table-row';
                  currentExpandedRow = detailsRow;
                } else {
                  detailsRow.style.display = 'none';
                }
              });
              
              // Ensure the selected row is visible
              rows[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
          }

          // Restore the original event listener
          document.addEventListener('keydown', handleArrowKeys);

          function renderRows(filterText = '') {
            selectedIndex = -1;  // Reset selection when rerendering
            // Remove all existing rows except header
            while (tbody.rows.length > 1) {
              tbody.deleteRow(1);
            }

            // Split query into terms and filter out empty strings, handling quotes
            const searchTerms = filterText.toLowerCase()
              .match(/[^\s"']+|"([^"]*)"|'([^']*)'/g)
              ?.map(term => term.replace(/^['"]|['"]$/g, '').toLowerCase())
              .filter(term => term.length > 0) || [];

            const sortedAttendees = sortAttendees();
            let hasExpandedRow = false;
            
            sortedAttendees.forEach(attendee => {
              const searchableText = [
                attendee.name_given || '',
                attendee.name_family || '',
                attendee.phone_canonical || '',
                attendee.email || '',
                attendee.description || '',
                ...(attendee.translator !== null ? attendee.languages_canonical || [] : []),
                (attendee.aga_id || '').toString(),
                attendee.aga_chapter || ''
              ].join(' ').toLowerCase();

              // Check if any tournament matches all search terms
              const tournamentText = (attendee.tournaments_canonical || []).join(' ').toLowerCase();

              // Check if all search terms match either searchableText or tournaments
              const allTermsMatch = searchTerms.every(term => 
                searchableText.includes(term) || tournamentText.includes(term)
              );

              if (!filterText || allTermsMatch) {
                const row = document.createElement('tr');
                const name = `${highlightText(attendee.name_given || '', filterText)} ${highlightText(attendee.name_family || '', filterText)}`;
                const description = highlightText(attendee.description || '', filterText);

                row.innerHTML = `
                  <td>
                    <span class="attendee-name">${name}</span>
                    <div style="font-size: 14px; color: #0a0; margin-top: 4px;">${description}</div>
                  </td>
                `;

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details';
                detailsRow.innerHTML = `
                  <td>
                    <div class="details-grid">
                      <div class="details-item">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">
                          ${highlightText(attendee.phone_canonical || 'N/A', filterText)}
                          ${attendee.phone_canonical ? `
                            <div style="margin-top: 4px">
                              <a href="sms:${attendee.phone_canonical}">[txt]</a>
                              <a href="tel:${attendee.phone_canonical}">[call]</a>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">
                          ${highlightText(attendee.email || 'N/A', filterText)}
                          ${attendee.email ? `
                            <div style="margin-top: 4px">
                              <a href="mailto:${attendee.email}">[email]</a>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">AGA Number:</div>
                        <div class="detail-value">${highlightText(attendee.aga_id || 'N/A', filterText)}</div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Club:</div>
                        <div class="detail-value">${highlightText(attendee.aga_chapter || 'N/A', filterText)}</div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Playing Rank:</div>
                        <div class="detail-value">${attendee.aga_rating ? attendee.aga_rating : 'N/A'}</div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Tournaments:</div>
                        <div class="detail-value">${(attendee.tournaments_canonical || []).map(t => highlightText(t, filterText)).join(', ') || 'None'}</div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Languages:</div>
                        <div class="detail-value">${attendee.languages_canonical.join(', ') || 'N/A'}</div>
                      </div>
                      <div class="details-item">
                        <div class="detail-label">Translator:</div>
                        <div class="detail-value">${attendee.translator ? 'Yes' : 'No'}</div>
                      </div>
                    </div>
                  </td>
                `;

                // Only expand if this is the tracked expanded row AND we haven't expanded another row yet
                if (attendee.id === lastExpandedAttendeeId && !hasExpandedRow) {
                  detailsRow.classList.add('visible');
                  row.classList.add('expanded');
                  hasExpandedRow = true;
                }

                row.addEventListener('click', (e) => {
                  if (currentExpandedRow === detailsRow) {
                    // Clicking already expanded row collapses it
                    detailsRow.style.display = 'none';
                    currentExpandedRow = null;
                  } else {
                    // Collapse any currently expanded row
                    if (currentExpandedRow) {
                      currentExpandedRow.style.display = 'none';
                    }
                    // Expand this row
                    detailsRow.style.display = 'table-row';
                    currentExpandedRow = detailsRow;
                  }
                });

                tbody.appendChild(row);
                tbody.appendChild(detailsRow);
                
                // Hide details row by default
                detailsRow.style.display = 'none';
              }
            });
          }

          // Initial render with no rows expanded
          lastExpandedAttendeeId = null;
          renderRows();

          // Add search handler
          searchInput.addEventListener('input', (e) => {
            renderRows(e.target.value);
          });

          function attendeeMatchesFilter(attendee, searchTerms) {
            if (!searchTerms.length) return true;
            
            const searchableFields = [
              attendee.name_given,
              attendee.name_family,
              attendee.tdlist_name,
              attendee.email,
              attendee.city,
              attendee.state,
              attendee.country,
              attendee.badge_rating,
              attendee.aga_chapter,
              // ... any other existing fields ...
            ];
            
            const searchText = searchableFields
              .filter(field => field) // Remove null/undefined values
              .join(' ')
              .toLowerCase();
            
            return searchTerms.every(term => searchText.includes(term));
          }

          // Add keyboard navigation
          document.addEventListener('keydown', (e) => {
            const rows = Array.from(tbody.getElementsByTagName('tr'))
              .filter(row => !row.classList.contains('details'));
            
            if (rows.length === 0) return;

            const currentIndex = rows.findIndex(row => row.contains(document.activeElement));
            let newIndex = currentIndex;

            switch (e.key) {
              case 'ArrowDown':
                e.preventDefault();
                newIndex = currentIndex < rows.length - 1 ? currentIndex + 1 : currentIndex;
                break;
              case 'ArrowUp':
                e.preventDefault();
                newIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                break;
              case 'Enter':
                e.preventDefault();
                if (currentIndex >= 0) {
                  rows[currentIndex].click();
                }
                return;
            }

            if (newIndex !== currentIndex || currentIndex === -1) {
              rows[newIndex].focus();
              rows[newIndex].click();
            }
          });

          // Make rows focusable
          const style = document.createElement('style');
          style.textContent = `
            tr:not(.details) {
              tabindex: 0;
              outline: none;
            }
            tr:not(.details):focus {
              background-color: #020;
            }
          `;
          document.head.appendChild(style);
        })
        .catch(error => {
          console.error('Error loading attendee data:', error);
          document.body.innerHTML += '<p style="color: red">Error loading attendee data</p>';
        });
    </script>
  </table>
</body>
</html>
